untangled
=========

Description
-----------

``untangled`` is the core clustering function of the UnTANGLeD pipeline that performs the final hierarchical clustering analysis using the consensus matrix generated by ``clusterOptimiser``. This function takes the optimal number of clusters (determined from silhouette analysis) and produces final cluster assignments along with internal quality metrics.


Methodology
-----------

The ``untangled`` function implements the following analytical workflow:

1. **Hierarchical Clustering:** Applies hierarchical clustering (Ward's method) to the consensus matrix using the specified optimal cluster number and cuts the dendrogram to produce final cluster memberships for all samples

2. **Quality Assessment:** Computes multiple internal validation metrics:
   - **Average Silhouette:** Measures how well samples fit within their assigned clusters
   - **Average Correlation:** Calculates within-cluster correlation using original scaled data matrix 
   - **Cluster Size / Names:** Reports cluster membership statistics

3. **Visualization:** Generates diagnostic plots showing the distribution of clusters along silhouette and correlation scores

4. **Output Generation:** Saves cluster assignments and summary statistics

Input and Output
----------------

**Input Requirements:**
  - Output directory from a completed ``clusterOptimiser`` run containing:
    - ``consensus_matrix.rds``: Consensus matrix from multi-resolution clustering
    - ``seurat_scaled_matrix.rds``: Seurat object with original scaled data matrix
  - Optimal cluster number (either from automatic detection or manual selection from silhouette plot)

**Output Files:**
  - ``gene_subgrp.rds``: Final cluster assignments for all samples/genes
  - ``UnTANGLeD_gene_cluster_summary.txt``: Comprehensive cluster quality metrics and statistics with the following columns:
    - ``cluster``: Cluster ID
    - ``mean_sil``: Average silhouette score for the cluster
    - ``mean_cor``: Average within-cluster correlation (absolute values)
    - ``clus_n``: Number of members in the cluster
    - ``names``: Comma-separated list of all members in the cluster
  - ``avg_silhouette_vs_correlation.pdf``: Diagnostic plot visualizing cluster quality relationships


Parameters
----------

- ``optimal_clusters``: An integer specifying the optimal number of clusters determined from the ``clusterOptimiser`` silhouette plot. This is the only required parameter. **Required**.

..

- ``outdir``: (Optional) A character string specifying the directory path containing ``clusterOptimiser`` outputs and where new results will be saved. Must match the ``outdir`` used in ``clusterOptimiser``. Default is ``"UnTANGLeD_output"``.

Cluster Quality Metrics
-----------------------

``untangled`` computes several key metrics to assess cluster quality:

**Silhouette Score:**
- Measures how similar a sample is to its own cluster compared to other clusters. Higher scores (e.g., >0.5) indicate more robust cluster assignments, with values closer to 1 representing the strongest clustering confidence.

**Within-Cluster Correlation:**
- Average Pearson correlation between samples within each cluster
- Higher values indicate greater cluster coherence, with values closer to 1 representing the strongest within-cluster similarity
- Measures feature similarity of clustered samples

**Cluster Size:**
- Number of samples assigned to each cluster

Usage Examples
--------------

**Example 1: Basic Usage After clusterOptimiser**

.. code-block:: R

    # After examining the silhouette plot from clusterOptimiser
    # and determining 150 is the optimal cluster number
    untangled(optimal_clusters = 150,
              outdir = "UnTANGLeD_output")

**Example 2: Custom Output Directory**

.. code-block:: R

    # Using a specific analysis directory
    untangled(optimal_clusters = 200,
              outdir = "my_drug_screen_analysis")

**Example 3: Testing Multiple Cluster Numbers**

.. code-block:: R

    # Test several promising cluster numbers identified from silhouette plot
    for(k in c(120, 150, 180)) {
        untangled(optimal_clusters = k,
                  outdir = paste0("analysis_k", k))
    }

**Example 4: Pipeline Integration**

.. code-block:: R

    # Complete pipeline workflow
    # Step 1: Cluster optimization
    clusterOptimiser(seu = my_seurat_object,
                     outdir = "drug_screen")
    
    # Step 2: Manual examination of silhouette plot
    # (examine drug_screen/average_silhouette_scores_by_cluster_number.pdf)
    
    # Step 3: Main clustering with optimal k
    untangled(optimal_clusters = 165,  # chosen from silhouette plot
              outdir = "drug_screen")

Interpreting Results
--------------------

**Cluster Summary File:**
The ``UnTANGLeD_gene_cluster_summary.txt`` file contains essential information for cluster prioritization:

.. code-block:: text

    cluster  mean_sil  mean_cor  clus_n  names
    1        0.67      0.43      45      comp1, comp2, comp3, ...
    2        0.61      0.38      32      comp45, comp46, ...
    3        0.59      0.41      78      comp77, comp78, ...
    ...


**Diagnostic Plot Interpretation:**
The ``avg_silhouette_vs_correlation.pdf`` plot shows the relationship between silhouette scores and correlation metrics:

- **Upper-right quadrant:** Best clusters (high silhouette, high correlation)

Considerations and Troubleshooting
----------------------------------

**Expected Runtime:**
- Typically < 1 minute
- Memory usage proportional to consensus matrix size

**Common Issues:**

1. **Missing input files:** Ensure ``clusterOptimiser`` completed successfully
2. **Poor cluster quality:** Consider different optimal cluster numbers or revisit preprocessing

**Quality Control Checks:**
- Verify reasonable distribution of cluster sizes
- Check that silhouette and correlation metrics show positive correlation
- Ensure summary statistics are within expected ranges

Next Steps
------------------------

After running ``untangled``, proceed with:

- Use conservation analysis functions (``gcc``, ``cmc``) to assess cross-dataset stability
- Examine biological pathway enrichment in top-ranked clusters
- Validate findings using orthogonal datasets
- Focus follow-up analyses on highest-ranked clusters
- Investigate cluster-specific phenotypes or molecular signatures


The ``untangled`` function provides the final cluster assignments and quality metrics needed for downstream prioritisation and follow-up