<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>clusterOptimiser &#8212; UnTANGLeD  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="untangled" href="untangled.html" />
    <link rel="prev" title="Installation" href="installation.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="clusteroptimiser">
<h1>clusterOptimiser<a class="headerlink" href="#clusteroptimiser" title="Link to this heading">¶</a></h1>
<section id="description">
<h2>Description<a class="headerlink" href="#description" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">clusterOptimiser</span></code> performs multi-resolution consensus clustering across a range of Seurat clustering granuarities. It constructs a consensus matrix from clustering assignments, automatically detects the optimal cluster number using plateau detection in silhouette analysis, and provides visualization tools to aid in cluster selection.</p>
</section>
<section id="methodology">
<h2>Methodology<a class="headerlink" href="#methodology" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">clusterOptimiser</span></code> implements the following workflow:</p>
<ol class="arabic simple">
<li><p><strong>Multi-resolution Clustering:</strong> Performs Seurat clustering across a user-defined range of resolutions (default 100 iterations: 0.2 to 20.0 in increments of 0.2)</p></li>
<li><p><strong>Consensus Matrix Construction:</strong> For each pair of samples, calculates the frequency of co-clustering across all resolutions to build a consensus similarity matrix</p></li>
<li><p><strong>Silhouette Analysis:</strong> Applies hierarchical clustering to the consensus matrix using various cluster numbers (2 to max_clusters) and computes average silhouette scores for each cluster number</p></li>
<li><p><strong>Automatic Plateau Detection:</strong> Identifies the optimal cluster number by detecting when silhouette score improvements plateau using a rolling mean approach with configurable threshold</p></li>
<li><p><strong>Visualization:</strong> Generates plots showing silhouette scores vs. cluster numbers with the detected optimal cluster number highlighted</p></li>
</ol>
</section>
<section id="input-and-output">
<h2>Input and Output<a class="headerlink" href="#input-and-output" title="Link to this heading">¶</a></h2>
<dl class="simple">
<dt><strong>Input:</strong></dt><dd><ul class="simple">
<li><p>A preprocessed Seurat object containing normalized and scaled gene expression data</p></li>
<li><p>The Seurat object should have completed standard preprocessing (normalization, scaling, PCA)</p></li>
</ul>
</dd>
<dt><strong>Output:</strong></dt><dd><p>The function generates several output files in the specified directory:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">seurat_scaled_matrix.rds</span></code>: Saved Seurat object for downstream analysis</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metadata_cluster_assignments.txt</span></code>: Table containing cluster assignments across all tested resolutions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">consensus_matrix.rds</span></code>: Consensus matrix representing co-clustering frequencies</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">average_silhouette_scores.txt</span></code>: Silhouette scores for each tested cluster number</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">optimal_cluster_number.txt</span></code>: Automatically detected optimal cluster number</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">average_silhouette_scores_by_cluster_number.pdf</span></code>: Visualization plot with optimal cluster number highlighted</p></li>
</ul>
</dd>
</dl>
</section>
<section id="parameters">
<h2>Parameters<a class="headerlink" href="#parameters" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">seu</span></code>: A Seurat object containing normalized gene expression data and preprocessed through standard Seurat workflows (scaling, PCA). <strong>Required</strong>.</p></li>
</ul>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">outdir</span></code>: (Optional) A character string specifying the directory path where output files will be saved. The function will create the directory if it does not exist. Default is <code class="docutils literal notranslate"><span class="pre">&quot;UnTANGLeD_output&quot;</span></code>.</p></li>
</ul>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">resolution</span></code>: (Optional) A numeric vector specifying the range of Seurat clustering resolutions to evaluate. The function iterates through these resolutions for consensus clustering analysis. Default is <code class="docutils literal notranslate"><span class="pre">seq(0.2,</span> <span class="pre">20,</span> <span class="pre">0.2)</span></code>.</p></li>
</ul>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">algorithm</span></code>: (Optional) An integer from 1 to 4 specifying which Seurat modularity optimisation algorithm to run for clustering (1 = original Louvain algorithm; 2 = Louvain algorithm with multilevel refinement; 3 = SLM algorithm; 4 = Leiden algorithm). Default is <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p></li>
</ul>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">max_clusters</span></code>: (Optional) An integer specifying the maximum number of clusters to evaluate during consensus matrix optimization. This sets the upper limit for silhouette analysis. Default is <code class="docutils literal notranslate"><span class="pre">300</span></code> or the number of samples in the dataset, whichever is smaller.</p></li>
</ul>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">thresh_frac</span></code>: (Optional) A numeric value between 0 and 1 specifying the threshold fraction for plateau detection. This parameter defines how strict the plateau definition is by setting the cutoff as a fraction of the maximum rolling gain. For example, a threshold of 0.1 means the optimal cluster number is identified when the silhouette score no longer increases by more than 10% of the mean silhouette increase over the last three consecutive cluster numbers. Default is <code class="docutils literal notranslate"><span class="pre">0.01</span></code>.</p></li>
</ul>
</section>
<section id="optimal-cluster-selection">
<h2>Optimal Cluster Selection<a class="headerlink" href="#optimal-cluster-selection" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">clusterOptimiser</span></code> function now <strong>automatically detects</strong> the optimal cluster number using plateau detection:</p>
<p><strong>Automatic Detection:</strong>
- Calculates the rate of silhouette score improvement using a rolling mean (window size = 3)
- Identifies the plateau point where improvement falls below a threshold (default: 1% of maximum gain)
- Saves the detected optimal cluster number to <code class="docutils literal notranslate"><span class="pre">optimal_cluster_number.txt</span></code>
- Highlights the optimal point with a red dashed line in the visualization plot</p>
<p><strong>Manual Review:</strong>
While the automatic detection provides a data-driven recommendation, users should:
- Examine the silhouette plot (<code class="docutils literal notranslate"><span class="pre">average_silhouette_scores_by_cluster_number.pdf</span></code>)
- Verify the detected optimal cluster number aligns with biological expectations
- Consider adjusting <code class="docutils literal notranslate"><span class="pre">thresh_frac</span></code> if the detection seems too conservative or aggressive
- Select alternative cluster numbers if domain knowledge suggests otherwise</p>
<p><strong>Interpretation:</strong>
- <strong>X-axis:</strong> Number of clusters (2 to max_clusters)
- <strong>Y-axis:</strong> Average silhouette score (0 to 1)
- <strong>Red dashed line:</strong> Automatically detected optimal cluster number
- <strong>Selection criteria:</strong> Balance between silhouette score and biological interpretability</p>
</section>
<section id="usage-examples">
<h2>Usage Examples<a class="headerlink" href="#usage-examples" title="Link to this heading">¶</a></h2>
<p><strong>Example 1: Basic Usage with Default Parameters</strong></p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assuming &#39;seu&#39; is your preprocessed Seurat object</span>
<span class="nf">clusterOptimiser</span><span class="p">(</span><span class="n">seu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seu</span><span class="p">,</span>
<span class="w">                 </span><span class="n">outdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;UnTANGLeD_output&quot;</span><span class="p">)</span>

<span class="c1"># The function will automatically detect optimal cluster number</span>
<span class="c1"># and display the recommended next step command</span>
</pre></div>
</div>
<p><strong>Example 2: Custom Resolution Range</strong></p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use finer resolution increments for detailed analysis</span>
<span class="nf">clusterOptimiser</span><span class="p">(</span><span class="n">seu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seu</span><span class="p">,</span>
<span class="w">                 </span><span class="n">outdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;my_analysis&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="n">resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Example 3: Limited Cluster Range for Smaller Datasets</strong></p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="c1"># Maximum number of clusters should not exceed the number of objects in the dataset</span>
<span class="nf">clusterOptimiser</span><span class="p">(</span><span class="n">seu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seu</span><span class="p">,</span>
<span class="w">                 </span><span class="n">outdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;my_analysis&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="n">resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">),</span>
<span class="w">                 </span><span class="n">max_clusters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">150</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Example 4: Leiden Algorithm with Custom Plateau Threshold</strong></p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use Leiden algorithm with more stringent plateau detection</span>
<span class="nf">clusterOptimiser</span><span class="p">(</span><span class="n">seu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seu</span><span class="p">,</span>
<span class="w">                 </span><span class="n">outdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;my_analysis&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="n">algorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span>
<span class="w">                 </span><span class="n">thresh_frac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="considerations-and-troubleshooting">
<h2>Considerations and Troubleshooting<a class="headerlink" href="#considerations-and-troubleshooting" title="Link to this heading">¶</a></h2>
<p><strong>Computational Time:</strong>
- Resolution range: more resolutions = longer runtime
- max_clusters: higher values = Extended silhouette computation
- Typical runtime: seconds to over 10 minutes for larger datasets</p>
<p><strong>Optimization Tips:</strong>
1. Start with default parameters for initial exploration
2. Adjust resolultion when needed. Higher resolution means finer clustering granularity.
3. Set reasonable max_clusters based on expected biological diversity (automatically capped at sample size)
4. Adjust <code class="docutils literal notranslate"><span class="pre">thresh_frac</span></code> if automatic detection seems too conservative (increase) or aggressive (decrease)</p>
<p><strong>Common Issues:</strong></p>
<ol class="arabic simple">
<li><p><strong>Long runtime:</strong> Use coarser resolution range or fewer resolution iterations</p></li>
<li><p><strong>Flat silhouette plot:</strong> Data may require additional preprocessing or different resolution range</p></li>
<li><p><strong>Missing Seurat object components:</strong> Ensure necessary scaling and PCA are completed.</p></li>
</ol>
<p><strong>Plateau Detection Adjustment:</strong>
- If optimal cluster number seems <strong>too low</strong>: decrease <code class="docutils literal notranslate"><span class="pre">thresh_frac</span></code> (e.g., from 0.01 to 0.005)
- If optimal cluster number seems <strong>too high</strong>: increase <code class="docutils literal notranslate"><span class="pre">thresh_frac</span></code> (e.g., from 0.01 to 0.1)
- Review the silhouette plot to verify the detection makes sense visually</p>
<p><strong>Quality Control:</strong>
- Check that silhouette plot shows steady increase before plateau
- Verify the detected optimal cluster number is marked clearly on the plot
- Verify consensus matrix contains reasonable co-clustering patterns
- Ensure all output files are generated successfully</p>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">¶</a></h2>
<p>After running <code class="docutils literal notranslate"><span class="pre">clusterOptimiser</span></code>:</p>
<ol class="arabic simple">
<li><p><strong>Review the console output</strong> which displays:
- The automatically detected optimal cluster number
- A recommended command for the next step with the detected optimal_clusters value</p></li>
<li><p><strong>Examine the silhouette plot</strong> (<code class="docutils literal notranslate"><span class="pre">average_silhouette_scores_by_cluster_number.pdf</span></code>) to:
- Verify the automatically detected optimal cluster number (marked with red dashed line)
- Check if the plateau detection aligns with visual inspection
- Consider alternative cluster numbers if manual inspection suggests otherwise</p></li>
<li><p><strong>Proceed to main clustering analysis</strong> using the recommended command:</p></li>
</ol>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example output message:</span>
<span class="c1"># =====================================</span>
<span class="c1"># Recommended next step:</span>
<span class="c1"># untangled(optimal_clusters = 115, outdir = &quot;UnTANGLeD_output&quot;)</span>
<span class="c1"># =====================================</span>

<span class="c1"># Copy and run the recommended command</span>
<span class="nf">untangled</span><span class="p">(</span><span class="n">optimal_clusters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">115</span><span class="p">,</span><span class="w"> </span><span class="n">outdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;UnTANGLeD_output&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">clusterOptimiser</span></code> function provides the foundation of UnTANGLeD analyses by establishing the consensus matrix, automatically detecting the optimal cluster number, and guiding users toward the next analysis step.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">UnTANGLeD</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">clusterOptimiser</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="#methodology">Methodology</a></li>
<li class="toctree-l2"><a class="reference internal" href="#input-and-output">Input and Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parameters">Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#optimal-cluster-selection">Optimal Cluster Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#usage-examples">Usage Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="#considerations-and-troubleshooting">Considerations and Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#next-steps">Next Steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="untangled.html">untangled</a></li>
<li class="toctree-l1"><a class="reference internal" href="conservation.html">Conservation Analysis</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="installation.html" title="previous chapter">Installation</a></li>
      <li>Next: <a href="untangled.html" title="next chapter">untangled</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Qiongyi Zhao & Shaine Bao.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/clusterOptimiser.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>